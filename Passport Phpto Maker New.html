<!-- Switch Button -->
<button id="switchBtn" style="position:fixed; right:20px; top:50%; transform:translateY(-50%); padding:10px 15px; background:#007bff; color:#fff; border:none; border-radius:5px; cursor:pointer; z-index:1000;"></button>

<!-- New Code Container (Default Visible) -->
<div id="newApp" style="display:block;">
  <!-- ‡§Ö‡§™‡§®‡•á New Code HTML ‡§Ø‡§π‡§æ‡§Å paste ‡§ï‡§∞‡•á‡§Ç -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

<style>
/* Base Reset & Font */
body {
    margin: 0;
    padding: 0;
    font-family: 'Poppins', sans-serif; 
    background-color: #e9ecef; 
    color: #343a40;
}

/* Main App Container */
#passport-photo-app {
    min-height: 100vh;
    width: 100%;
    margin: 0; 
    padding: 40px 20px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    gap: 30px; 
}

/* Header/Logo Section */
.header-section {
    text-align: center;
    margin-bottom: 20px;
}
.header-section h1 {
    color: #007bff;
    font-size: 2.8em;
    font-weight: 800;
    margin-bottom: 5px;
}
.header-section p {
    color: #6c757d;
    font-size: 1.1em;
    margin: 0;
}

/* Card Styling for all sections */
.portal-card {
    background-color: #ffffff;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    padding: 30px;
    width: 95%;
    max-width: 800px;
    box-sizing: border-box;
}

/* Drop Area */
#drop-area {
    border: 3px dashed #17a2b8; 
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}

#drop-area.highlight {
    background-color: #f0f8ff;
    border-color: #007bff;
}

#file-input { display: none; }

/* Buttons */
.button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 30px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1.05em;
    transition: background-color 0.3s, transform 0.2s;
    box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
}

.button:hover {
    background-color: #0056b3;
    transform: translateY(-1px);
}

.primary-button { background-color: #28a745; box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3); }
.primary-button:hover { background-color: #1e7e34; }
.download-button { 
    background-color: #fd7e14; 
    color: white;
    box-shadow: 0 4px 10px rgba(253, 126, 20, 0.3);
}
.download-button:hover { background-color: #e8710c; }

/* Cropper/Image Container */
#image-container {
    height: 480px; 
    display: none; 
}

/* Controls Panel */
#controls {
    display: none;
    flex-direction: column;
    gap: 20px;
}
.control-group {
    display: flex;
    flex-direction: column;
    gap: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
}

/* Output Area */
#output-area {
    display: none;
    flex-direction: column;
    text-align: center;
    gap: 20px;
}

#final-image-preview {
    max-width: 100%;
    height: auto;
    border: 1px solid #ddd;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
    border-radius: 5px;
}
</style>

<div id="passport-photo-app">
    <div class="header-section">
        <h1><i class="fas fa-id-card-clip"></i> E-‡§∏‡•á‡§µ‡§æ ‡•û‡•ã‡§ü‡•ã ‡§ú‡§®‡§∞‡•á‡§ü‡§∞</h1>
        <p>‡§™‡•ç‡§∞‡•ã‡§´‡•á‡§∂‡§®‡§≤ ‡§™‡§æ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§´‡•ã‡§ü‡•ã ‡§ï‡•ç‡§∞‡•â‡§™‡§∞ ‡§î‡§∞ $\text{A4}$ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§∂‡•Ä‡§ü ‡§ü‡•Ç‡§≤‡•§</p>
    </div>
    
    <div id="drop-area" class="portal-card">
        <p style="font-size: 1.2em; font-weight: 500;">‡•û‡•ã‡§ü‡•ã ‡§Ø‡§π‡§æ‡§Ç **‡§°‡•ç‡§∞‡•â‡§™** ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ</p>
        <input type="file" id="file-input" accept="image/*" />
        <label for="file-input" class="button"><i class="fas fa-upload"></i> ‡•û‡§æ‡§á‡§≤ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç</label>
        <p style="font-size: 0.9em; color: #777;">‡§™‡§æ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡§æ‡§á‡•õ $\text{3.5 cm x 4.5 cm}$ ‡§è‡§∏‡•ç‡§™‡•á‡§ï‡•ç‡§ü ‡§∞‡•á‡§∂‡•ç‡§Ø‡•ã</p>
    </div>

    <div id="image-container" class="portal-card">
        <img id="image-to-crop" src="" alt="Image to Crop" style="display:none;">
    </div>

    <div id="controls" class="portal-card">
        <div class="control-group">
            <p style="font-size: 1em; color: #007bff; font-weight: 600;">
                <i class="fas fa-arrows-alt"></i> **‡§ï‡•ç‡§∞‡•â‡§™‡§ø‡§Ç‡§ó ‡§è‡§°‡§ú‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç:** ‡§ï‡•Ä‡§¨‡•ã‡§∞‡•ç‡§° ‡§ï‡•á $\text{Arrow Keys}$ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§
            </p>
            <label>
                <input type="checkbox" id="add-white-border-checkbox" checked> 
                <i class="fas fa-border-all"></i> **‡§∏‡§´‡•á‡§¶ ‡§¨‡•â‡§∞‡•ç‡§°‡§∞ (Stock) ‡§ú‡•ã‡§°‡§º‡•á‡§Ç**
            </label>
            <label>
                <input type="checkbox" id="add-black-border-checkbox"> 
                <i class="fas fa-crop-simple"></i> **‡§¨‡•ç‡§≤‡•à‡§ï ‡§ï‡§ü‡§ø‡§Ç‡§ó ‡§ó‡§æ‡§á‡§°** ($\text{3px}$)
            </label>
            
            <button id="crop-button" class="button primary-button">
                <i class="fas fa-check-circle"></i> ‡§ï‡•ç‡§∞‡•â‡§™ ‡§î‡§∞ ‡•û‡•ã‡§ü‡•ã ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç
            </button>
        </div>

        <div id="print-options" style="display:none; flex-direction: column; gap: 15px;">
            <h3 style="color: #343a40; margin-top: 0;"><i class="fas fa-print"></i> ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü‡§ø‡§Ç‡§ó ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™</h3>
            <select id="print-layout-select" style="padding: 10px; border-radius: 6px; border: 1px solid #ccc;">
                <option value="A4_6" selected>A4 ‡§∏‡§æ‡§á‡•õ ‡§Æ‡•á‡§Ç 6 ‡•û‡•ã‡§ü‡•ã (1 ‡§≤‡§æ‡§á‡§® ‡§Æ‡•á‡§Ç)</option>
            </select>
            <button id="generate-print-button" class="button primary-button" style="margin-top: 10px;">
                <i class="fas fa-file-pdf"></i> ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§∂‡•Ä‡§ü ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
            </button>
        </div>
    </div>

    <div id="output-area" class="portal-card">
        <h3><i class="fas fa-paper-plane"></i> ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§Ü‡§â‡§ü‡§™‡•Å‡§ü</h3>
        <img id="final-image-preview" src="" alt="Final Passport Photo">
        <a id="download-link" class="button download-button" download="A4_Print_Sheet.jpeg">
            <i class="fas fa-download"></i> ‡•û‡§æ‡§á‡§≤ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
        </a>
    </div>
</div>

<script>
// --- DOM Elements ---
const fileInput = document.getElementById('file-input');
const dropArea = document.getElementById('drop-area');
const controls = document.getElementById('controls');
const cropButton = document.getElementById('crop-button');
const finalImagePreview = document.getElementById('final-image-preview');
const downloadLink = document.getElementById('download-link');
const outputArea = document.getElementById('output-area');
const addWhiteBorderCheckbox = document.getElementById('add-white-border-checkbox');
const addBlackBorderCheckbox = document.getElementById('add-black-border-checkbox');
const generatePrintButton = document.getElementById('generate-print-button');
const imageToCrop = document.getElementById('image-to-crop');

// --- Constants ---
let cropper;
let croppedImageBlob = null;
const PASSPORT_ASPECT_RATIO = 3.5 / 4.5;
const DPI = 300;

// A4 Size in 300 DPI pixels
const A4_WIDTH_PX = 2480; 
const A4_HEIGHT_PX = 3508; 
const PHOTO_COUNT = 6;
const FIXED_TOP_MARGIN = 180; 

// Dynamic Photo Size Calculation (THE FIX)
// A4 ‡§ö‡•å‡•ú‡§æ‡§à (2480px) ‡§Æ‡•á‡§Ç 6 ‡§´‡§º‡•ã‡§ü‡•ã ‡§î‡§∞ 7 ‡§∏‡§Æ‡§æ‡§® ‡§ó‡•à‡§™/‡§Æ‡§æ‡§∞‡•ç‡§ú‡§ø‡§® ‡§ï‡•ã ‡§∏‡§Æ‡§æ‡§® ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§´‡§ø‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ ‡§ö‡•å‡•ú‡§æ‡§à ‡§ï‡•Ä ‡§ó‡§£‡§®‡§æ
const TOTAL_SLOTS = PHOTO_COUNT + 1; // 2 side margins + 5 internal gaps = 7 slots
const MAX_PHOTO_WIDTH_PX = Math.floor(A4_WIDTH_PX / TOTAL_SLOTS);

// Final Photo Dimensions (Aspect Ratio Maintained)
// ‡§π‡§Æ ‡§Æ‡§æ‡§®‡§§‡•á ‡§π‡•à‡§Ç ‡§ï‡§ø ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§´‡•ã‡§ü‡•ã (‡§¨‡•â‡§∞‡•ç‡§°‡§∞ ‡§∏‡§π‡§ø‡§§) ‡§ï‡•ã ‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ 354 ‡§™‡§ø‡§ï‡•ç‡§∏‡§≤ ‡§ï‡•Ä ‡§ö‡•å‡§°‡§º‡§æ‡§à ‡§Æ‡§ø‡§≤ ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à
let FINAL_PHOTO_W_PX = MAX_PHOTO_WIDTH_PX;
let FINAL_PHOTO_H_PX = Math.round(FINAL_PHOTO_W_PX / PASSPORT_ASPECT_RATIO); 

// Note: If borders are added later (13px per side), the actual image size 
// before borders must be reduced to ensure the final size does not exceed MAX_PHOTO_WIDTH_PX.
// This logic is handled in the `createPrintSheet` function by using the actual width of `singlePhotoImg`.


// --- Cropper Initialization ---
function handleFiles(files) {
    if (files.length === 0 || !files[0].type.startsWith('image/')) {
        alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§á‡§Æ‡•á‡§ú ‡•û‡§æ‡§á‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§');
        return;
    }
    
    const file = files[0];
    const reader = new FileReader();

    reader.onload = (e) => {
        if (cropper) cropper.destroy();

        imageToCrop.src = e.target.result;
        imageToCrop.style.display = 'block';
        document.getElementById('image-container').style.display = 'block';
        dropArea.style.display = 'none';
        controls.style.display = 'flex'; 
        document.getElementById('print-options').style.display = 'none';
        outputArea.style.display = 'none';

        cropper = new Cropper(imageToCrop, {
            aspectRatio: PASSPORT_ASPECT_RATIO,
            viewMode: 1, 
            dragMode: 'move', 
            autoCropArea: 0.8,
            responsive: true,
            background: false,
            zoomable: true,
            rotatable: false,
            scalable: false,
            wheelZoomRatio: 0, // FIX: Mouse wheel zooming is disabled
        });
    };
    reader.readAsDataURL(file);
}

// FIX: Arrow Key Logic (Moves the CROP BOX (cropper-face) directly)
document.addEventListener('keydown', (e) => {
    if (!cropper || controls.style.display === 'none') return; 

    // Move amount in pixels for the crop box
    const moveAmount = 2; 
    let deltaX = 0;
    let deltaY = 0;

    switch (e.key) {
        case 'ArrowLeft':
            e.preventDefault();
            deltaX = -moveAmount; // Move crop box left
            break;
        case 'ArrowRight':
            e.preventDefault();
            deltaX = moveAmount; // Move crop box right
            break;
        case 'ArrowUp':
            e.preventDefault();
            deltaY = -moveAmount; // Move crop box up
            break;
        case 'ArrowDown':
            e.preventDefault();
            deltaY = moveAmount; // Move crop box down
            break;
    }
    
    if (deltaX !== 0 || deltaY !== 0) {
        const cropBoxData = cropper.getCropBoxData();
        
        cropper.setCropBoxData({
            left: cropBoxData.left + deltaX,
            top: cropBoxData.top + deltaY,
        });
    }
});


// --- Crop and Border Logic ---
cropButton.addEventListener('click', () => {
    if (!cropper) {
        alert('‡§™‡§π‡§≤‡•á ‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡•û‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç‡•§');
        return;
    }
    
    // 1. Get the base cropped image using the dynamically calculated size
    // Note: We use the FINAL_PHOTO_W_PX derived from A4 width, guaranteeing fit.
    const croppedCanvas = cropper.getCroppedCanvas({
        width: FINAL_PHOTO_W_PX,
        height: FINAL_PHOTO_H_PX,
        fillColor: '#fff',
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high',
    });

    const needWhiteBorder = addWhiteBorderCheckbox.checked;
    const needBlackBorder = addBlackBorderCheckbox.checked;

    let finalPhotoCanvas = croppedCanvas;
    let finalPhotoWidth = FINAL_PHOTO_W_PX;
    let finalPhotoHeight = FINAL_PHOTO_H_PX;

    // 2. ‡§∏‡§´‡•á‡§¶ ‡§¨‡•â‡§∞‡•ç‡§°‡§∞ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç (10px)
    if (needWhiteBorder) {
        const whiteBorderSize = 10;
        finalPhotoWidth += 2 * whiteBorderSize;
        finalPhotoHeight += 2 * whiteBorderSize;
        
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = finalPhotoWidth;
        tempCanvas.height = finalPhotoHeight;
        const ctx = tempCanvas.getContext('2d');

        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        ctx.drawImage(finalPhotoCanvas, whiteBorderSize, whiteBorderSize);
        finalPhotoCanvas = tempCanvas;
    }

    // 3. ‡§¨‡•ç‡§≤‡•à‡§ï ‡§¨‡•â‡§∞‡•ç‡§°‡§∞ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç (3px)
    if (needBlackBorder) {
        const blackBorderSize = 3;
        finalPhotoWidth += 2 * blackBorderSize;
        finalPhotoHeight += 2 * blackBorderSize;

        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = finalPhotoWidth;
        tempCanvas.height = finalPhotoHeight;
        const ctx = tempCanvas.getContext('2d');

        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        ctx.drawImage(finalPhotoCanvas, blackBorderSize, blackBorderSize, finalPhotoWidth - 2 * blackBorderSize, finalPhotoHeight - 2 * blackBorderSize);
        finalPhotoCanvas = tempCanvas;
    }
    
    finalPhotoCanvas.toBlob((blob) => {
        if (blob) {
            croppedImageBlob = blob;
            const url = URL.createObjectURL(blob);
            finalImagePreview.src = url;
            downloadLink.href = url;
            downloadLink.download = 'Cropped_Passport_Photo.jpeg';
            outputArea.style.display = 'flex';
            document.getElementById('print-options').style.display = 'flex';
        } else {
            alert('‡§á‡§Æ‡•á‡§ú ‡§ï‡•ã ‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§');
        }
    }, 'image/jpeg', 0.95);
});

// --- Print Sheet Generator (A4 1x6 Final Fixed Logic) ---

generatePrintButton.addEventListener('click', () => {
    if (!croppedImageBlob) {
        alert('‡§™‡§π‡§≤‡•á ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡•Ä ‡•û‡•ã‡§ü‡•ã ‡§ï‡•ç‡§∞‡•â‡§™ ‡§î‡§∞ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç‡•§');
        return;
    }

    const img = new Image();
    img.onload = () => {
        createPrintSheet(img);
    };
    img.src = URL.createObjectURL(croppedImageBlob);
});

function createPrintSheet(singlePhotoImg) {
    
    // photoW now includes all borders (if selected)
    const photoW = singlePhotoImg.width;
    const photoH = singlePhotoImg.height;

    // 1. Calculate the required space for all photos
    const requiredPhotoWidth = photoW * PHOTO_COUNT;
    
    // 2. Calculate the remaining space for gaps and margins
    const remainingSpace = A4_WIDTH_PX - requiredPhotoWidth;
    
    // FIX: The calculation now uses the actual final size of the cropped image (photoW), 
    // which was limited earlier to guarantee remainingSpace >= 0.
    if (remainingSpace < 0) {
        // This is a safety catch, but should not happen with the dynamic sizing fix applied earlier.
        alert('FATAL ERROR: A4 ‡§™‡•á‡§ú ‡§™‡§∞ 6 ‡•û‡•ã‡§ü‡•ã ‡§´‡§ø‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§§‡•Ä‡•§');
        return;
    }

    // 3. Distribute the remaining space evenly across 7 slots
    const totalDistributionPoints = PHOTO_COUNT + 1; 
    const equalSpace = remainingSpace / totalDistributionPoints;
    const sideMargin = equalSpace; // Left/Right margin
    const photoGap = equalSpace;    // Margin between photos 

    // Canvas ‡§¨‡§®‡§æ‡§è‡§Å
    const printCanvas = document.createElement('canvas');
    printCanvas.width = A4_WIDTH_PX;
    printCanvas.height = A4_HEIGHT_PX;
    const ctx = printCanvas.getContext('2d');

    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, A4_WIDTH_PX, A4_HEIGHT_PX);

    // ‡§á‡§Æ‡•á‡§ú‡•á‡•õ ‡§ï‡•ã ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç (Top-Center Aligned)
    for (let c = 0; c < PHOTO_COUNT; c++) { 
        // X ‡§ï‡•ã‡§ë‡§∞‡•ç‡§°‡§ø‡§®‡•á‡§ü‡•ç‡§∏
        const x = sideMargin + c * photoW + c * photoGap;
        // Y ‡§ï‡•ã‡§ë‡§∞‡•ç‡§°‡§ø‡§®‡•á‡§ü‡•ç‡§∏: Fixed Top Margin
        const y = FIXED_TOP_MARGIN; 

        ctx.drawImage(singlePhotoImg, x, y, photoW, photoH);
    }

    // ‡§Ü‡§â‡§ü‡§™‡•Å‡§ü ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
    finalImagePreview.src = printCanvas.toDataURL('image/jpeg', 0.95);
    downloadLink.href = printCanvas.toDataURL('image/jpeg', 0.95);
    downloadLink.download = `A4_6Photo_Print_Sheet_DPI300.jpeg`;
    outputArea.style.display = 'flex';
    alert(`‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§∂‡•Ä‡§ü "A4 ‡§∏‡§æ‡§á‡•õ ‡§Æ‡•á‡§Ç 6 ‡•û‡•ã‡§ü‡•ã" ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡§®‡§∞‡•á‡§ü ‡§π‡•ã ‡§ó‡§à ‡§π‡•à!`);
}


// --- Utility and Event Listeners ---
function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

// Drag/Drop Listeners
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, preventDefaults, false);
});
['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false);
});
['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false);
});
dropArea.addEventListener('drop', (e) => { handleFiles(e.dataTransfer.files); }, false);
fileInput.addEventListener('change', (e) => { handleFiles(e.target.files); });


window.onload = () => {
    dropArea.style.display = 'flex';
};
</script>
  <h2>New Code Page</h2>
</div>

<!-- Old Code Container (Default Hidden) -->
<div id="oldApp" style="display:none;">
  <!-- ‡§Ö‡§™‡§®‡•á Old Code HTML ‡§Ø‡§π‡§æ‡§Å paste ‡§ï‡§∞‡•á‡§Ç -->
<!-- Old Code -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

<style>
/* Full Screen/Responsive Styling */
#passport-photo-app {
    min-height: 100vh;
    width: 100%;
    margin: -8px; /* ‡§¨‡•ç‡§≤‡•â‡§ó‡§∞ ‡§ï‡•á ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§Æ‡§æ‡§∞‡•ç‡§ú‡§ø‡§® ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡•á ‡§ï‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ */
    padding: 20px;
    box-sizing: border-box;
    background-color: #f7f7f7; /* ‡§π‡§≤‡•ç‡§ï‡§æ ‡§ó‡•ç‡§∞‡•á ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° */
    font-family: 'Arial', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start; /* ‡§ä‡§™‡§∞ ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç */
    text-align: center;
}

h2 {
    color: #333;
    margin-bottom: 20px;
}

/* ‡§°‡•ç‡§∞‡•à‡§ó-‡§è‡§Ç‡§°-‡§°‡•ç‡§∞‡•â‡§™ ‡§è‡§∞‡§ø‡§Ø‡§æ */
#drop-area {
    border: 3px dashed #007bff;
    border-radius: 15px;
    padding: 40px;
    width: 90%;
    max-width: 700px;
    margin-bottom: 30px;
    cursor: pointer;
    background-color: #fff;
    transition: background-color 0.3s;
}

#drop-area.highlight {
    background-color: #e6f7ff;
}

#file-input {
    display: none;
}

.button {
    display: inline-block;
    padding: 10px 25px;
    margin: 10px 5px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    text-decoration: none;
    font-weight: bold;
    font-size: 16px;
    transition: background-color 0.3s, transform 0.2s;
}

.button:hover {
    background-color: #0056b3;
    transform: translateY(-2px);
}

.primary-button {
    background-color: #28a745;
}

.primary-button:hover {
    background-color: #1e7e34;
}

.download-button {
    background-color: #ffc107;
    color: #333;
}

/* ‡§á‡§Æ‡•á‡§ú ‡§î‡§∞ ‡§ï‡•ç‡§∞‡•â‡§™‡§∞ ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ */
#image-container {
    width: 90%;
    max-width: 700px;
    max-height: 60vh; /* ‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ ‡§ä‡§Ç‡§ö‡§æ‡§à */
    margin-bottom: 20px;
    display: none; /* ‡§∂‡•Å‡§∞‡•Ç ‡§Æ‡•á‡§Ç ‡§õ‡§ø‡§™‡§æ ‡§π‡•Å‡§Ü */
}

/* Cropper.js ‡§ï‡•á ‡§≤‡§ø‡§è ‡•õ‡§∞‡•Ç‡§∞‡•Ä */
#image-to-crop {
    max-width: 100%;
    max-height: 100%;
    display: block;
}

/* ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£ ‡§™‡•à‡§®‡§≤ */
#controls {
    width: 90%;
    max-width: 700px;
    padding: 15px;
    background-color: #ffffff;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    display: none; /* ‡§∂‡•Å‡§∞‡•Ç ‡§Æ‡•á‡§Ç ‡§õ‡§ø‡§™‡§æ ‡§π‡•Å‡§Ü */
}

#controls label {
    display: block;
    margin: 10px 0;
    font-weight: bold;
}

/* ‡§´‡§æ‡§á‡§®‡§≤ ‡§Ü‡§â‡§ü‡§™‡•Å‡§ü */
#output-area {
    width: 90%;
    max-width: 700px;
    margin-top: 30px;
    padding: 20px;
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    display: none;
}

#final-image-preview {
    max-width: 100%;
    height: auto;
    border: 1px solid #ccc;
    margin-bottom: 15px;
}

/* ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤/‡§ü‡•à‡§¨‡§≤‡•á‡§ü ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∞‡§ø‡§∏‡•ç‡§™‡•â‡§®‡•ç‡§∏‡§ø‡§µ ‡§è‡§°‡§ú‡§∏‡•ç‡§ü‡§Æ‡•á‡§Ç‡§ü */
@media (max-width: 768px) {
    #passport-photo-app {
        padding: 10px;
        align-items: stretch;
    }
    #drop-area, #image-container, #controls, #output-area {
        width: 100%;
        max-width: none;
    }
}
</style>

<div id="passport-photo-app">
    <h2>üáÆüá≥ ‡§™‡§æ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§´‡•ã‡§ü‡•ã ‡§ï‡•ç‡§∞‡•â‡§™‡§∞</h2>
    
    <div id="drop-area">
        <p>‡•û‡•ã‡§ü‡•ã ‡§Ø‡§π‡§æ‡§Ç **‡§°‡•ç‡§∞‡•â‡§™** ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ</p>
        <input type="file" id="file-input" accept="image/*" />
        <label for="file-input" class="button">‡•û‡§æ‡§á‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç</label>
        <p style="font-size: 14px; color: #777;">*‡§ï‡•á‡§µ‡§≤ JPEG/PNG ‡§á‡§Æ‡•á‡§ú ‡§π‡•Ä ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü‡•á‡§° ‡§π‡•à‡§Ç‡•§</p>
    </div>

    <div id="image-container">
        <img id="image-to-crop" src="" alt="Image to Crop" style="display:none;">
    </div>

    <div id="controls">
        <label>
            <input type="checkbox" id="add-border-checkbox" checked> 
            **‡§∏‡§´‡•á‡§¶ ‡§¨‡•â‡§∞‡•ç‡§°‡§∞ (Stock) ‡§ú‡•ã‡§°‡§º‡•á‡§Ç** (‡§™‡§æ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§´‡•ã‡§ü‡•ã ‡§ï‡•á ‡§≤‡§ø‡§è ‡•õ‡§∞‡•Ç‡§∞‡•Ä)
        </label>
        
        <button id="crop-button" class="button primary-button">
            ‡§ï‡•ç‡§∞‡•â‡§™ ‡§î‡§∞ ‡•û‡•ã‡§ü‡•ã ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç
        </button>
    </div>

    <div id="output-area">
        <h3>‡§§‡•à‡§Ø‡§æ‡§∞ ‡•û‡•ã‡§ü‡•ã</h3>
        <img id="final-image-preview" src="" alt="Final Passport Photo">
        <a id="download-link" class="button download-button" download="indian_passport_photo.jpeg">
            ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
        </a>
    </div>
</div>

<script>
const fileInput = document.getElementById('file-input');
const dropArea = document.getElementById('drop-area');
const imageToCrop = document.getElementById('image-to-crop');
const imageContainer = document.getElementById('image-container');
const controls = document.getElementById('controls');
const cropButton = document.getElementById('crop-button');
const finalImagePreview = document.getElementById('final-image-preview');
const downloadLink = document.getElementById('download-link');
const outputArea = document.getElementById('output-area');
const addBorderCheckbox = document.getElementById('add-border-checkbox');

let cropper;
const PASSPORT_ASPECT_RATIO = 3.5 / 4.5; // ‡§á‡§Ç‡§°‡§ø‡§Ø‡§® ‡§™‡§æ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡§æ‡§á‡•õ ‡§ï‡§æ ‡§Ö‡§®‡•Å‡§™‡§æ‡§§ (3.5cm ‡§ö‡•å‡§°‡§º‡§æ‡§à x 4.5cm ‡§ä‡§Ç‡§ö‡§æ‡§à)

// --- Drag/Drop ‡§î‡§∞ ‡§´‡§º‡§æ‡§á‡§≤ ‡§π‡•à‡§Ç‡§°‡§≤‡§ø‡§Ç‡§ó ---
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, preventDefaults, false);
});

['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false);
});

dropArea.addEventListener('drop', (e) => {
    handleFiles(e.dataTransfer.files);
}, false);

fileInput.addEventListener('change', (e) => {
    handleFiles(e.target.files);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

function handleFiles(files) {
    if (files.length === 0 || !files[0].type.startsWith('image/')) {
        alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§á‡§Æ‡•á‡§ú ‡§´‡§º‡§æ‡§á‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§');
        return;
    }
    
    const file = files[0];
    const reader = new FileReader();

    reader.onload = (e) => {
        // 1. Cropper ‡§ï‡•ã ‡§®‡§∑‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç (‡§Ö‡§ó‡§∞ ‡§Ø‡§π ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§ö‡§≤ ‡§∞‡§π‡§æ ‡§π‡•à)
        if (cropper) {
            cropper.destroy();
        }

        // 2. ‡§á‡§Æ‡•á‡§ú ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ UI ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
        imageToCrop.src = e.target.result;
        imageToCrop.style.display = 'block';
        imageContainer.style.display = 'block';
        dropArea.style.display = 'none'; // ‡§°‡•ç‡§∞‡•â‡§™ ‡§è‡§∞‡§ø‡§Ø‡§æ ‡§õ‡§ø‡§™‡§æ‡§è‡§Å
        controls.style.display = 'block';
        outputArea.style.display = 'none'; // ‡§™‡§ø‡§õ‡§≤‡§æ ‡§Ü‡§â‡§ü‡§™‡•Å‡§ü ‡§õ‡§ø‡§™‡§æ‡§è‡§Å

        // 3. Cropper.js ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç
        cropper = new Cropper(imageToCrop, {
            aspectRatio: PASSPORT_ASPECT_RATIO,
            viewMode: 1, // ‡§ï‡•ç‡§∞‡•â‡§™‡§∞ ‡§ï‡•ã ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§ï‡•á ‡§∏‡§æ‡§á‡•õ ‡§Æ‡•á‡§Ç ‡§´‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç
            dragMode: 'move',
            autoCropArea: 0.8, // ‡§∏‡•ç‡§µ‡§ö‡§æ‡§≤‡§ø‡§§ ‡§ï‡•ç‡§∞‡•â‡§™ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞
            responsive: true,
            background: false,
        });
    };
    
    reader.readAsDataURL(file);
}

// --- ‡§ï‡•ç‡§∞‡•â‡§™ ‡§î‡§∞ ‡§á‡§Æ‡•á‡§ú ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡§æ ‡§≤‡•â‡§ú‡§ø‡§ï ---

cropButton.addEventListener('click', () => {
    if (!cropper) {
        alert('‡§™‡§π‡§≤‡•á ‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡•û‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç‡•§');
        return;
    }

    // Cropper ‡§∏‡•á ‡§ï‡•ç‡§∞‡•â‡§™ ‡§ï‡§ø‡§è ‡§ó‡§è Canvas ‡§ï‡•ã ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç
    const croppedCanvas = cropper.getCroppedCanvas({
        width: 350,  // 3.5cm ‡§ï‡•ã 350px ‡§Æ‡§æ‡§® ‡§≤‡•á‡§Ç (DPI ‡§ï‡•á ‡§≤‡§ø‡§è)
        height: 450, // 4.5cm ‡§ï‡•ã 450px ‡§Æ‡§æ‡§® ‡§≤‡•á‡§Ç
        fillColor: '#fff',
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high',
    });

    const needBorder = addBorderCheckbox.checked;

    if (needBorder) {
        // ‡§¨‡•â‡§∞‡•ç‡§°‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§®‡§Ø‡§æ Canvas ‡§¨‡§®‡§æ‡§è‡§Å
        const borderSize = 10; // 10px ‡§∏‡§´‡•á‡§¶ ‡§¨‡•â‡§∞‡•ç‡§°‡§∞
        const finalCanvas = document.createElement('canvas');
        finalCanvas.width = croppedCanvas.width + 2 * borderSize;
        finalCanvas.height = croppedCanvas.height + 2 * borderSize;
        const ctx = finalCanvas.getContext('2d');

        // ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° ‡§ï‡•ã ‡§∏‡§´‡•á‡§¶ ‡§∞‡§Ç‡§ó ‡§∏‡•á ‡§≠‡§∞‡•á‡§Ç (‡§¨‡•â‡§∞‡•ç‡§°‡§∞)
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);

        // ‡§ï‡•ç‡§∞‡•â‡§™ ‡§ï‡•Ä ‡§ó‡§à ‡§á‡§Æ‡•á‡§ú ‡§ï‡•ã ‡§¨‡•â‡§∞‡•ç‡§°‡§∞ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§°‡•ç‡§∞‡§æ ‡§ï‡§∞‡•á‡§Ç
        ctx.drawImage(croppedCanvas, borderSize, borderSize);

        // ‡§´‡§æ‡§á‡§®‡§≤ ‡§á‡§Æ‡•á‡§ú ‡§Ü‡§â‡§ü‡§™‡•Å‡§ü
        generateOutput(finalCanvas);
    } else {
        // ‡§¨‡•â‡§∞‡•ç‡§°‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§ö‡§æ‡§π‡§ø‡§è, ‡§∏‡•Ä‡§ß‡•á ‡§ï‡•ç‡§∞‡•â‡§™ ‡§ï‡•Ä ‡§ó‡§à ‡§á‡§Æ‡•á‡§ú ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç
        generateOutput(croppedCanvas);
    }
});

function generateOutput(canvasElement) {
    // Canvas ‡§ï‡•ã JPEG ‡§°‡•á‡§ü‡§æ URL ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡•á‡§Ç
    // JPEG ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§Ö‡§ï‡•ç‡§∏‡§∞ ‡§™‡§æ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§´‡•ã‡§ü‡•ã ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à
    const finalImageURL = canvasElement.toDataURL('image/jpeg', 0.95);

    // ‡§Ü‡§â‡§ü‡§™‡•Å‡§ü ‡§è‡§∞‡§ø‡§Ø‡§æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
    finalImagePreview.src = finalImageURL;
    downloadLink.href = finalImageURL;
    outputArea.style.display = 'block';

    // (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï) Cropper ‡§ï‡•ã ‡§®‡§∑‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ UI ‡§ï‡•ã ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
    // cropper.destroy();
    // imageContainer.style.display = 'none';
    // controls.style.display = 'none';
    // dropArea.style.display = 'block';
}

// ‡§∂‡•Å‡§∞‡•Ç ‡§Æ‡•á‡§Ç ‡§°‡•ç‡§∞‡•â‡§™ ‡§è‡§∞‡§ø‡§Ø‡§æ ‡§ï‡•ã ‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á ‡§ï‡§∞‡•á‡§Ç
window.onload = () => {
    dropArea.style.display = 'block';
};
</script>

<!-- old code End -->
  <h2>Old Code Page</h2>
</div>

<script>
var switchBtn = document.getElementById('switchBtn');
var newApp = document.getElementById('newApp');
var oldApp = document.getElementById('oldApp');
var showingNew = true;

// Initialize button text
switchBtn.textContent = "Switch to Old";

switchBtn.addEventListener('click', function() {
    if(showingNew){
        newApp.style.display = 'none';
        oldApp.style.display = 'block';
        switchBtn.textContent = "Switch to New";
    } else {
        oldApp.style.display = 'none';
        newApp.style.display = 'block';
        switchBtn.textContent = "Switch to Old";
    }
    showingNew = !showingNew;
});
</script>
