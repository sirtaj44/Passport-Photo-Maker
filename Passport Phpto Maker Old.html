<!-- Old Code -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

<style>
/* Full Screen/Responsive Styling */
#passport-photo-app {
    min-height: 100vh;
    width: 100%;
    margin: -8px; /* рдмреНрд▓реЙрдЧрд░ рдХреЗ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдорд╛рд░реНрдЬрд┐рди рдХреЛ рд╣рдЯрд╛рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ */
    padding: 20px;
    box-sizing: border-box;
    background-color: #f7f7f7; /* рд╣рд▓реНрдХрд╛ рдЧреНрд░реЗ рдмреИрдХрдЧреНрд░рд╛рдЙрдВрдб */
    font-family: 'Arial', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start; /* рдКрдкрд░ рд╕реЗ рд╢реБрд░реВ рдХрд░реЗрдВ */
    text-align: center;
}

h2 {
    color: #333;
    margin-bottom: 20px;
}

/* рдбреНрд░реИрдЧ-рдПрдВрдб-рдбреНрд░реЙрдк рдПрд░рд┐рдпрд╛ */
#drop-area {
    border: 3px dashed #007bff;
    border-radius: 15px;
    padding: 40px;
    width: 90%;
    max-width: 700px;
    margin-bottom: 30px;
    cursor: pointer;
    background-color: #fff;
    transition: background-color 0.3s;
}

#drop-area.highlight {
    background-color: #e6f7ff;
}

#file-input {
    display: none;
}

.button {
    display: inline-block;
    padding: 10px 25px;
    margin: 10px 5px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    text-decoration: none;
    font-weight: bold;
    font-size: 16px;
    transition: background-color 0.3s, transform 0.2s;
}

.button:hover {
    background-color: #0056b3;
    transform: translateY(-2px);
}

.primary-button {
    background-color: #28a745;
}

.primary-button:hover {
    background-color: #1e7e34;
}

.download-button {
    background-color: #ffc107;
    color: #333;
}

/* рдЗрдореЗрдЬ рдФрд░ рдХреНрд░реЙрдкрд░ рдХрдВрдЯреЗрдирд░ */
#image-container {
    width: 90%;
    max-width: 700px;
    max-height: 60vh; /* рдЕрдзрд┐рдХрддрдо рдКрдВрдЪрд╛рдИ */
    margin-bottom: 20px;
    display: none; /* рд╢реБрд░реВ рдореЗрдВ рдЫрд┐рдкрд╛ рд╣реБрдЖ */
}

/* Cropper.js рдХреЗ рд▓рд┐рдП реЫрд░реВрд░реА */
#image-to-crop {
    max-width: 100%;
    max-height: 100%;
    display: block;
}

/* рдирд┐рдпрдВрддреНрд░рдг рдкреИрдирд▓ */
#controls {
    width: 90%;
    max-width: 700px;
    padding: 15px;
    background-color: #ffffff;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    display: none; /* рд╢реБрд░реВ рдореЗрдВ рдЫрд┐рдкрд╛ рд╣реБрдЖ */
}

#controls label {
    display: block;
    margin: 10px 0;
    font-weight: bold;
}

/* рдлрд╛рдЗрдирд▓ рдЖрдЙрдЯрдкреБрдЯ */
#output-area {
    width: 90%;
    max-width: 700px;
    margin-top: 30px;
    padding: 20px;
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    display: none;
}

#final-image-preview {
    max-width: 100%;
    height: auto;
    border: 1px solid #ccc;
    margin-bottom: 15px;
}

/* рдореЛрдмрд╛рдЗрд▓/рдЯреИрдмрд▓реЗрдЯ рдХреЗ рд▓рд┐рдП рд░рд┐рд╕реНрдкреЙрдиреНрд╕рд┐рд╡ рдПрдбрдЬрд╕реНрдЯрдореЗрдВрдЯ */
@media (max-width: 768px) {
    #passport-photo-app {
        padding: 10px;
        align-items: stretch;
    }
    #drop-area, #image-container, #controls, #output-area {
        width: 100%;
        max-width: none;
    }
}
</style>

<div id="passport-photo-app">
    <h2>ЁЯЗоЁЯЗ│ рдкрд╛рд╕рдкреЛрд░реНрдЯ рдлреЛрдЯреЛ рдХреНрд░реЙрдкрд░</h2>
    
    <div id="drop-area">
        <p>реЮреЛрдЯреЛ рдпрд╣рд╛рдВ **рдбреНрд░реЙрдк** рдХрд░реЗрдВ рдпрд╛</p>
        <input type="file" id="file-input" accept="image/*" />
        <label for="file-input" class="button">реЮрд╛рдЗрд▓ рдЪреБрдиреЗрдВ</label>
        <p style="font-size: 14px; color: #777;">*рдХреЗрд╡рд▓ JPEG/PNG рдЗрдореЗрдЬ рд╣реА рд╕рдкреЛрд░реНрдЯреЗрдб рд╣реИрдВред</p>
    </div>

    <div id="image-container">
        <img id="image-to-crop" src="" alt="Image to Crop" style="display:none;">
    </div>

    <div id="controls">
        <label>
            <input type="checkbox" id="add-border-checkbox" checked> 
            **рд╕рдлреЗрдж рдмреЙрд░реНрдбрд░ (Stock) рдЬреЛрдбрд╝реЗрдВ** (рдкрд╛рд╕рдкреЛрд░реНрдЯ рдлреЛрдЯреЛ рдХреЗ рд▓рд┐рдП реЫрд░реВрд░реА)
        </label>
        
        <button id="crop-button" class="button primary-button">
            рдХреНрд░реЙрдк рдФрд░ реЮреЛрдЯреЛ рддреИрдпрд╛рд░ рдХрд░реЗрдВ
        </button>
    </div>

    <div id="output-area">
        <h3>рддреИрдпрд╛рд░ реЮреЛрдЯреЛ</h3>
        <img id="final-image-preview" src="" alt="Final Passport Photo">
        <a id="download-link" class="button download-button" download="indian_passport_photo.jpeg">
            рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ
        </a>
    </div>
</div>

<script>
const fileInput = document.getElementById('file-input');
const dropArea = document.getElementById('drop-area');
const imageToCrop = document.getElementById('image-to-crop');
const imageContainer = document.getElementById('image-container');
const controls = document.getElementById('controls');
const cropButton = document.getElementById('crop-button');
const finalImagePreview = document.getElementById('final-image-preview');
const downloadLink = document.getElementById('download-link');
const outputArea = document.getElementById('output-area');
const addBorderCheckbox = document.getElementById('add-border-checkbox');

let cropper;
const PASSPORT_ASPECT_RATIO = 3.5 / 4.5; // рдЗрдВрдбрд┐рдпрди рдкрд╛рд╕рдкреЛрд░реНрдЯ рд╕рд╛рдЗреЫ рдХрд╛ рдЕрдиреБрдкрд╛рдд (3.5cm рдЪреМрдбрд╝рд╛рдИ x 4.5cm рдКрдВрдЪрд╛рдИ)

// --- Drag/Drop рдФрд░ рдлрд╝рд╛рдЗрд▓ рд╣реИрдВрдбрд▓рд┐рдВрдЧ ---
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, preventDefaults, false);
});

['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false);
});

dropArea.addEventListener('drop', (e) => {
    handleFiles(e.dataTransfer.files);
}, false);

fileInput.addEventListener('change', (e) => {
    handleFiles(e.target.files);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

function handleFiles(files) {
    if (files.length === 0 || !files[0].type.startsWith('image/')) {
        alert('рдХреГрдкрдпрд╛ рдПрдХ рдЗрдореЗрдЬ рдлрд╝рд╛рдЗрд▓ рдЪреБрдиреЗрдВред');
        return;
    }
    
    const file = files[0];
    const reader = new FileReader();

    reader.onload = (e) => {
        // 1. Cropper рдХреЛ рдирд╖реНрдЯ рдХрд░реЗрдВ (рдЕрдЧрд░ рдпрд╣ рдкрд╣рд▓реЗ рд╕реЗ рдЪрд▓ рд░рд╣рд╛ рд╣реИ)
        if (cropper) {
            cropper.destroy();
        }

        // 2. рдЗрдореЗрдЬ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░реЗрдВ рдФрд░ UI рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ
        imageToCrop.src = e.target.result;
        imageToCrop.style.display = 'block';
        imageContainer.style.display = 'block';
        dropArea.style.display = 'none'; // рдбреНрд░реЙрдк рдПрд░рд┐рдпрд╛ рдЫрд┐рдкрд╛рдПрдБ
        controls.style.display = 'block';
        outputArea.style.display = 'none'; // рдкрд┐рдЫрд▓рд╛ рдЖрдЙрдЯрдкреБрдЯ рдЫрд┐рдкрд╛рдПрдБ

        // 3. Cropper.js рд╢реБрд░реВ рдХрд░реЗрдВ
        cropper = new Cropper(imageToCrop, {
            aspectRatio: PASSPORT_ASPECT_RATIO,
            viewMode: 1, // рдХреНрд░реЙрдкрд░ рдХреЛ рдХрдВрдЯреЗрдирд░ рдХреЗ рд╕рд╛рдЗреЫ рдореЗрдВ рдлрд┐рдЯ рдХрд░реЗрдВ
            dragMode: 'move',
            autoCropArea: 0.8, // рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХреНрд░реЙрдк рдХреНрд╖реЗрддреНрд░
            responsive: true,
            background: false,
        });
    };
    
    reader.readAsDataURL(file);
}

// --- рдХреНрд░реЙрдк рдФрд░ рдЗрдореЗрдЬ рдмрдирд╛рдиреЗ рдХрд╛ рд▓реЙрдЬрд┐рдХ ---

cropButton.addEventListener('click', () => {
    if (!cropper) {
        alert('рдкрд╣рд▓реЗ рдХреГрдкрдпрд╛ рдПрдХ реЮреЛрдЯреЛ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВред');
        return;
    }

    // Cropper рд╕реЗ рдХреНрд░реЙрдк рдХрд┐рдП рдЧрдП Canvas рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
    const croppedCanvas = cropper.getCroppedCanvas({
        width: 350,  // 3.5cm рдХреЛ 350px рдорд╛рди рд▓реЗрдВ (DPI рдХреЗ рд▓рд┐рдП)
        height: 450, // 4.5cm рдХреЛ 450px рдорд╛рди рд▓реЗрдВ
        fillColor: '#fff',
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high',
    });

    const needBorder = addBorderCheckbox.checked;

    if (needBorder) {
        // рдмреЙрд░реНрдбрд░ рдХреЗ рд▓рд┐рдП рдПрдХ рдирдпрд╛ Canvas рдмрдирд╛рдПрдБ
        const borderSize = 10; // 10px рд╕рдлреЗрдж рдмреЙрд░реНрдбрд░
        const finalCanvas = document.createElement('canvas');
        finalCanvas.width = croppedCanvas.width + 2 * borderSize;
        finalCanvas.height = croppedCanvas.height + 2 * borderSize;
        const ctx = finalCanvas.getContext('2d');

        // рдмреИрдХрдЧреНрд░рд╛рдЙрдВрдб рдХреЛ рд╕рдлреЗрдж рд░рдВрдЧ рд╕реЗ рднрд░реЗрдВ (рдмреЙрд░реНрдбрд░)
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);

        // рдХреНрд░реЙрдк рдХреА рдЧрдИ рдЗрдореЗрдЬ рдХреЛ рдмреЙрд░реНрдбрд░ рдХреЗ рдЕрдВрджрд░ рдбреНрд░рд╛ рдХрд░реЗрдВ
        ctx.drawImage(croppedCanvas, borderSize, borderSize);

        // рдлрд╛рдЗрдирд▓ рдЗрдореЗрдЬ рдЖрдЙрдЯрдкреБрдЯ
        generateOutput(finalCanvas);
    } else {
        // рдмреЙрд░реНрдбрд░ рдирд╣реАрдВ рдЪрд╛рд╣рд┐рдП, рд╕реАрдзреЗ рдХреНрд░реЙрдк рдХреА рдЧрдИ рдЗрдореЗрдЬ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ
        generateOutput(croppedCanvas);
    }
});

function generateOutput(canvasElement) {
    // Canvas рдХреЛ JPEG рдбреЗрдЯрд╛ URL рдореЗрдВ рдмрджрд▓реЗрдВ
    // JPEG рдХрд╛ рдЙрдкрдпреЛрдЧ рдЕрдХреНрд╕рд░ рдкрд╛рд╕рдкреЛрд░реНрдЯ рдлреЛрдЯреЛ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ
    const finalImageURL = canvasElement.toDataURL('image/jpeg', 0.95);

    // рдЖрдЙрдЯрдкреБрдЯ рдПрд░рд┐рдпрд╛ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ
    finalImagePreview.src = finalImageURL;
    downloadLink.href = finalImageURL;
    outputArea.style.display = 'block';

    // (рд╡реИрдХрд▓реНрдкрд┐рдХ) Cropper рдХреЛ рдирд╖реНрдЯ рдХрд░реЗрдВ рдФрд░ UI рдХреЛ рд░реАрд╕реЗрдЯ рдХрд░реЗрдВ
    // cropper.destroy();
    // imageContainer.style.display = 'none';
    // controls.style.display = 'none';
    // dropArea.style.display = 'block';
}

// рд╢реБрд░реВ рдореЗрдВ рдбреНрд░реЙрдк рдПрд░рд┐рдпрд╛ рдХреЛ рдбрд┐рд╕реНрдкреНрд▓реЗ рдХрд░реЗрдВ
window.onload = () => {
    dropArea.style.display = 'block';
};
</script>

<!-- old code End -->